# Context

Filename: test-metrics-task.md
Created On: 2025-01-16T10:30:00Z
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description

基于 prd.md 设计并实现 test-metrics 工具 - 一个专为 CI 构建阶段设计的测试度量分析工具，支持 monorepo 多包聚合，自动分析覆盖率报告并上报到既有接口。

# Project Overview

test-metrics 是一个 TypeScript + Node.js CLI 工具，专注于分析已生成的测试覆盖率报告（不执行测试），充分利用 CI 环境变量，支持多种覆盖率格式解析，计算补丁覆盖率，并提供阈值门禁功能。工具设计目标是在 200ms 内完成分析，支持并发处理多包，最终输出人类可读摘要和机器可读 JSON。

---

## _以下部分由 AI 在协议执行过程中维护_

# Analysis (Populated by RESEARCH mode)

## 核心需求分析

- **工具定位**：专为 CI 环境设计，仅分析覆盖率文件，不执行测试
- **输入处理**：支持 coverage-summary.json、lcov.info、cobertura.xml 等格式
- **输出要求**：双格式输出（控制台 + JSON），自动上报既有接口
- **性能约束**：工具自身开销 < 200ms，支持大文件流式处理

## 技术架构识别

9个核心模块：ci-detector、change-resolver、workspace-resolver、coverage-finder、coverage-parsers、patch-analyzer、aggregator、threshold-gate、uploader、renderer

## 关键技术挑战

- CI 环境适配（支持多平台）
- Monorepo 支持（并发分析）
- 补丁覆盖率计算（Git diff + 覆盖率对齐）
- 多格式兼容性（统一数据模型）
- 性能优化（流式解析、并发控制）

# Proposed Solution (Populated by INNOVATE mode)

## 选定架构方案

**分层单体架构** + **管道思维优化**

- CLI Layer → Detection Layer → Analysis Layer → Aggregation Layer → Output Layer
- 优势：架构清晰、性能优秀、开发复杂度适中、便于并发优化

## 技术选型决策

- **Git 操作**：原生 git 命令（性能优先）+ simple-git fallback
- **覆盖率解析**：混合方案（JSON 自实现 + 复杂格式用专用库）
- **并发控制**：p-limit 库（轻量可靠）
- **配置管理**：cosmiconfig（多格式支持）

## 核心算法设计

- **CI 检测**：责任链模式，按优先级检测各 CI 平台
- **补丁覆盖率**：Git diff 解析 + 覆盖率数据行级对齐
- **多包聚合**：加权算法避免简单平均的偏差

# Implementation Plan (Generated by PLAN mode)

## 详细技术规范

### 项目结构设计

```
src/
├── cli/                 # CLI 层
│   ├── index.ts        # 入口点
│   ├── parse-args.ts   # 参数解析
│   └── exit-code.ts    # 退出码定义
├── core/               # 核心业务层
│   ├── ci-detector.ts     # CI 环境检测
│   ├── change-resolver.ts # 变更范围解析
│   ├── workspace-resolver.ts # 工作区包定位
│   ├── coverage-finder.ts    # 覆盖率文件查找
│   ├── patch-analyzer.ts     # 补丁覆盖率计算
│   └── aggregator.ts        # 聚合统计
├── parsers/            # 解析器层
│   ├── json-summary.ts    # Istanbul JSON 解析
│   ├── lcov.ts           # LCOV 解析
│   ├── cobertura.ts      # Cobertura XML 解析
│   └── index.ts          # 解析器工厂
├── output/             # 输出层
│   ├── renderer.ts     # 控制台输出渲染
│   ├── uploader.ts     # 自动上报
│   └── threshold.ts    # 阈值门禁
├── utils/              # 工具层
│   ├── git.ts         # Git 操作封装
│   ├── config.ts      # 配置管理
│   ├── logger.ts      # 日志工具
│   └── file.ts        # 文件操作工具
└── types/              # 类型定义
    ├── coverage.ts    # 覆盖率数据模型
    ├── config.ts      # 配置类型
    └── result.ts      # 输出结果类型
```

### 核心类型定义

```typescript
// types/coverage.ts
interface CoverageMetric {
  covered: number
  total: number
  pct: number
}

interface FileCoverage {
  path: string
  statements: CoverageMetric
  lines: CoverageMetric
  functions: CoverageMetric
  branches: CoverageMetric
}

interface PackageCoverage {
  name: string
  path: string
  files: FileCoverage[]
  summary: {
    statements: CoverageMetric
    lines: CoverageMetric
    functions: CoverageMetric
    branches: CoverageMetric
  }
  tests: TestResults
  durationMs: number
}

// types/result.ts
interface AnalysisResult {
  repo: string
  commit: string
  branch: string
  prNumber?: number
  ci: string
  generator: string
  changedFiles: string[]
  affectedPackages: string[]
  summary: CoverageMetric[]
  patch?: PatchCoverage
  totals: TestTotals
  byPackage: PackageResult[]
  threshold: ThresholdResult
  durationMs: number
  env: EnvironmentInfo
}
```

### CLI 参数设计

```typescript
interface CliOptions {
  full?: boolean // 全仓库分析
  format?: 'auto' | 'json-summary' | 'lcov' | 'cobertura'
  upload?: boolean // 启用上报
  jsonOnly?: boolean // 仅JSON输出
  config?: string // 配置文件路径
  keep?: boolean // 保留覆盖率文件
  debug?: boolean // 调试模式
  commit?: string // 覆盖提交哈希
  branch?: string // 覆盖分支名
  pr?: string // 覆盖PR号
  base?: string // 补丁基线
  output?: string // 输出文件路径
}
```

## Implementation Checklist:

1. **项目基础设置**
   - 初始化 TypeScript 配置和构建工具
   - 配置 ESLint、Prettier 代码规范
   - 设置测试框架（Vitest）和 CI 配置
   - 配置包管理和发布脚本

2. **核心类型定义**
   - 定义 CoverageMetric、FileCoverage、PackageCoverage 类型
   - 定义 AnalysisResult、TestResults 等结果类型
   - 定义 CliOptions、Config 等配置类型

3. **CLI 层实现**
   - 实现 parse-args.ts 命令行参数解析
   - 实现 exit-code.ts 退出码定义
   - 实现 cli/index.ts 主入口逻辑

4. **工具层基础设施**
   - 实现 utils/config.ts 配置文件加载（基于 cosmiconfig）
   - 实现 utils/logger.ts 日志工具（支持调试模式）
   - 实现 utils/file.ts 文件操作工具
   - 实现 utils/git.ts Git 操作封装

5. **CI 环境检测模块**
   - 实现 core/ci-detector.ts CI 平台识别
   - 支持 GitHub Actions、GitLab CI、Jenkins 检测
   - 提取分支、提交、PR、变更文件等信息

6. **变更范围解析模块**
   - 实现 core/change-resolver.ts 变更文件获取
   - 优先使用 CI 环境变量，fallback 到 Git diff
   - 实现文件过滤（node_modules、dist 等）

7. **工作区包定位模块**
   - 实现 core/workspace-resolver.ts 包定位逻辑
   - 基于变更文件向上查找 package.json
   - 支持 monorepo 工作区识别和去重

8. **覆盖率文件查找模块**
   - 实现 core/coverage-finder.ts 覆盖率文件自动查找
   - 支持多种格式和路径的智能探测
   - 实现文件存在性验证和格式预检

9. **覆盖率解析器实现**
   - 实现 parsers/json-summary.ts Istanbul JSON 解析器
   - 实现 parsers/lcov.ts LCOV 解析器
   - 实现 parsers/cobertura.ts Cobertura XML 解析器
   - 实现 parsers/index.ts 解析器工厂和格式自动检测

10. **补丁覆盖率分析模块**
    - 实现 core/patch-analyzer.ts Git diff 解析
    - 实现变更行提取和覆盖率数据对齐算法
    - 处理文件重命名、删除等边界情况

11. **聚合统计模块**
    - 实现 core/aggregator.ts 多包数据聚合
    - 实现加权平均算法避免简单平均偏差
    - 并发处理多包数据，支持失败隔离

12. **阈值门禁模块**
    - 实现 output/threshold.ts 阈值检查逻辑
    - 支持总覆盖率和补丁覆盖率门禁
    - 配置化阈值设置和警告提示

13. **输出渲染模块**
    - 实现 output/renderer.ts 控制台输出渲染
    - 彩色输出支持（chalk/picocolors）
    - 人类可读格式和 JSON 格式输出

14. **自动上报模块**
    - 实现 output/uploader.ts 上报接口集成
    - HTTP 请求、重试机制、Gzip 压缩
    - 幂等性保证和错误处理

15. **集成测试和优化**
    - 编写端到端测试覆盖主要场景
    - 性能测试和优化（目标 < 200ms）
    - 内存使用优化和大文件处理测试

16. **文档和部署准备**
    - 编写 README 和使用文档
    - CI 集成示例（GitHub Actions、GitLab CI）
    - 发布配置和版本管理

# Current Execution Step

> 准备开始执行：步骤1 - 项目基础设置

# Task Progress

_待执行步骤完成后追加记录_

# Final Review

_REVIEW模式时填充实现合规性评估_
